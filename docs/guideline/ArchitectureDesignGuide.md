# 設計する上で気をつけたいこと

- [設計する上で気をつけたいこと](#設計する上で気をつけたいこと)
  - [このガイドはなんのためにあるのか](#このガイドはなんのためにあるのか)
  - [Practices](#practices)
    - [MUST](#must)
      - [API の要求条件は API Gateway に定められた要件を満たしていなければならない](#api-の要求条件は-api-gateway-に定められた要件を満たしていなければならない)
      - [処理に必要な時間、メモリ等は Lambda の制限を超えてはならない](#処理に必要な時間メモリ等は-lambda-の制限を超えてはならない)
      - [一時的にファイルの読み書きを行う場合は`/tmp`ディレクトリを使用しなければならない](#一時的にファイルの読み書きを行う場合はtmpディレクトリを使用しなければならない)
      - [ステートレスなアプリケーションにしなければならない](#ステートレスなアプリケーションにしなければならない)
      - [DB アクセスは RDS Proxy など外部のコネクションプールを用いなければならない](#db-アクセスは-rds-proxy-など外部のコネクションプールを用いなければならない)
      - [クラウドサービス上のサービス名には、通常は環境名(dev, staging, prod)を入れなければならない](#クラウドサービス上のサービス名には通常は環境名dev-staging-prodを入れなければならない)
    - [Recommend](#recommend)
      - [Infrastructure as Code の思想に従い、コードで書ける物はコードに起こす](#infrastructure-as-code-の思想に従いコードで書ける物はコードに起こす)
      - [マネージドサービスを駆使してアーキテクチャを設計する](#マネージドサービスを駆使してアーキテクチャを設計する)
      - [エラーを検知可能な状態にする](#エラーを検知可能な状態にする)
    - [optional](#optional)

## このガイドはなんのためにあるのか

このガイドはこのリポジトリで開発する上で考慮しなければならない設計思想についてまとめてあります。  
以下の区分にしたがって分類されています。

[../guideline/Guide.md](../guideline/Guide.md)に準拠する形でこのプラクティス集は記述されています。

- MUST
  - 必ず守らなければならないと言っていいレベルで準拠したいプラクティス
  - 守らない場合 FaaS での開発をやめ、CaaS に移行しなければならない物も含みます
- Recommend
  - 多くの場合準拠した方が良いプラクティス
  - 守らない場合は設計の変更が必要になる場合があります
  - このアプリケーションの思想・コンセプトから外れる物も含みます。
- optional
  - 必須では無いものの準拠した方が良いプラクティス
  - 使用・構築するサービスによっては不要となるものが含まれています
  - 使用しない場合でもこれに順ずる設計思想を定めておくと良いでしょう

## Practices

### MUST

#### API の要求条件は API Gateway に定められた要件を満たしていなければならない

- 概要
  - <https://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html>
- 守られない場合
  - リクエストがエラーとなり、正しい結果を得ることが出来ません
- 回避策
  - 実行時間制限(30sec)の場合
    - 非同期に処理をするように変更しましょう
  - レスポンスのサイズが上限(10MB)に達している場合
    - S3 などにアップロードして、そこから一時リンクなどを利用して取得するようにしましょう

#### 処理に必要な時間、メモリ等は Lambda の制限を超えてはならない

- 概要
  - <https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/gettingstarted-limits.html>
- 守られない場合
  - パフォーマンスが極端に落ちたり、プロセスが Kill されるような挙動になり、正常に動作しない場合があります。
- 回避策
  - バッチ処理などは細かく分割し、Step Functions などを使って制御しましょう
  - メモリの割当量を増やすにつれ割り当てられる CPU は増加するため、実行時間が長い場合はメモリの割り当てを増やしてみましょう
    - <https://docs.aws.amazon.com/lambda/latest/dg/configuration-function-common.html>
    - 1769MB の割り当てで 1vCPU となるため、そこまでは正比例に CPU パワーが増加します。
    - 以降はマルチスレッド化などを行わないと、恩恵は受けにくいかもしれません。

#### 一時的にファイルの読み書きを行う場合は`/tmp`ディレクトリを使用しなければならない

- 概要
  - <https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/gettingstarted-limits.html>
  - `/tmp`で使用できる容量は最大約 10GB まで変更可能です。
    - デフォルトは 512MB
- 守られない場合
  - 関数が異常終了する可能性があり、システムの安定性を大きく損ないます

#### ステートレスなアプリケーションにしなければならない

- 概要
  - Lambda はサーバーレスなため、並列にアクセスされた場合は無制限にスケーリングが行われます
  - どのインスタンスにアクセスされるかは不明です
  - 1 回の動作で完結する一時的なキャッシュや、不変の定数に対するキャッシュ(環境変数など)などを除いてオンメモリやローカルのファイルにデータを保存しないようにしましょう
- 守られない場合
  - リクエストに対する整合性が取れなくなり、想定した挙動にならない可能性が高いです
- 回避策
  - DB や S3 等、外部のストレージに保存するようにしましょう
  - どうしてもステートフルにしなければならない場合は、FaaS ではなく、KaaS などを使用しましょう

#### DB アクセスは RDS Proxy など外部のコネクションプールを用いなければならない

- 概要
  - Lambda はサーバーレスなため、並列にアクセスされた場合は無制限にスケーリングが行われます
  - そのため、プログラムでコネクションプールを作成しても意図したとおりに動作しない可能性が高いです
- 守られない場合
  - DB アクセスが不安定になり、パフォーマンスが極端に低下する場合があります
- 回避策
  - コネクションプールを作成したとしても、サイズは 1 にしましょう
    - これは接続数が枯渇することを防ぐためです

#### クラウドサービス上のサービス名には、通常は環境名(dev, staging, prod)を入れなければならない

### Recommend

#### Infrastructure as Code の思想に従い、コードで書ける物はコードに起こす

- 概要
  - AWS のリソースはもちろん、テスト、DB 定義等ありとあらゆるものをコード化し、Git 管理下に置くことを推奨します
- 守られない場合
  - 管理が大変になります
    - 抜け漏れや二重計上など、人為的なミスにより管理しているものと実際の状態に差異が生まれます
  - 作業が属人化しやすくなります
    - コードに起こすことにより、誰でも同じ結果を得ることが出来るようになります
- 補足
  - Recommend の理由
    - PJ の規模などによってはコードに起こさずに手で起こした方が簡単かもしれないため
    - IaC 困難なリソースなども存在するため

#### マネージドサービスを駆使してアーキテクチャを設計する

- 概要
  - DB やエンドポイント、サービス間の連携に至るまで、あらゆるサーバレスなマネージドサービスを利用しましょう
    - DB
      - RDS Aurora
      - DynamoDB
    - エンドポイント
      - API Gateway
      - CloudFront
    - サービス間の連携
      - SQS
      - Cognito
- 守られない場合
  - 管理が大変になります
    - 自力で実装するより安全性・効率も高く、メンテナンスの作業も減ります
  - 費用が高くなったり、サーバレスなアーキテクチャの恩恵が得られなくなる可能性が高いです
- 補足
  - Recommend の理由
    - プログラムで実装する方が費用を抑えられるケースもあるため
  - この項目でもし docker 上でサービスを動かす必要がある場合は CaaS や KaaS に移行した方が良い可能性があります

#### エラーを検知可能な状態にする

- 概要
  - 各サービスの障害やプログラムのエラーなどは検知し、通知できる状態にしておくのが好ましいです。
- 守られない場合
  - エラーが検知できず、障害の対応が遅れます
  - サービスが落ちていることに気が付かない可能性があります

### optional
